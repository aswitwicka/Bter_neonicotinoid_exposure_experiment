--- 
title: "Bombus pesticide exposure: gene expression in head"
output: gene_level_3treatments.html
--- 

# Introduction
This script is for differential gene expression analysis of transcript quantification data.
Input files should be abundance files (.h5, .tsv, .json) generated by [Kallisto](https://pachterlab.github.io/kallisto/manual) 
for each sample and .txt file of genome transcripts 
and their corresponding gene ids (LOC numbers)/.

This script will import abundance files from Kallisto and use the R package [DESeq2](http://bioconductor.org/packages/release/bioc/html/DESeq.html) on count data to test for 
differential expression based on a model using negative binomial distribution.
This script produces a results table of genes that are significantly differentially expressed. 
This script uses the Wald test in DESeq2 to test for differential expression between treatments.
This can then be used for further analysis. 


```{r}
# Load libraries; install from scratch if needed
libraries <- c("tximport", "readr", "DESeq2", "ggplot2", "gplots", "rhdf5",
               "plyr", "ggfortify", "biomaRt", "vsn", "RColorBrewer", "ReportingTools")
for (lib in libraries) {
    if (require(package = lib, character.only = TRUE)) {
        print("Successful")
    } else {
        print("Installing")
        source("https://bioconductor.org/biocLite.R")
#        biocLite(pkgs = lib)
        library(lib, character.only = TRUE )
    }
}
dir.create("results")
```


## Step One: Input results from kallisto

We use raw, non-normalised estimated counts.
```{r} 
## Set paths to folders containing output files from kallisto
paths <- list()
paths$sample_batch_info <- "input/room_batch_information_per_sample-clean.txt"
paths$kallisto_output   <- "input/kallisto_quantification"

# Set relative paths:
paths$kallisto_files_relative <- grep(x       = list.files(paths$kallisto_output, recursive = TRUE),
                                      pattern = ".tsv", 
                                      value   = TRUE)
paths$kallisto_files <- file.path(paths$kallisto_output,
                                  paths$kallisto_files_relative)

# Automatically extract file names from kallisto output for colnames
names(paths$kallisto_files) <- gsub(paths$kallisto_files_relative, pattern="/.*", replacement="") 


for (filenumber in 1:length(paths$kallisto_files)) {
  current_name <- names(paths$kallisto_files)[filenumber]
  current_file <- paths$kallisto_files[filenumber]
  if (FALSE == grepl(pattern = current_name, x = current_file)) {
    kill("we have a problem - names and filenames dont match up")
  }
}
```


## Step Two: Put sample names and treatments into a samples dataframe for DESeqDataSetFromTximport

```{r}
## Extract sample names and put into df for tximport
samples     <- data.frame(treatment = names(paths$kallisto_files))

## Read in sample information for room and batch:
samples_information <- read.table(file = paths$sample_batch_info,
                                  header = FALSE, 
                                  col.names = c("sample_name", "treatment", "room", "batch"),
                                  row.names = 1)

## Make sure 'CON' is the reference:
samples_information$treatment <- relevel(x = samples_information$treatment, ref = "CON") 

# sanity check
if (FALSE == all(samples$treatment %in% rownames(samples_information))) {
    kill("we have a problem - sample names from files and from batch descriptor file  dont match up")
}

```


## Step Three: Import kallisto quantification files using Tximport

We used kallisto to obtain estimated counts for each transcript in each condition. 
We load these raw counts into R for DEseq using tximport. 
Because we do a gene-level analysis first, transcript abundances are summarised per gene during import.

```{r}
# Read in file corresponding to transcripts to gene ids
ensembl <- useMart("metazoa_mart", host = "metazoa.ensembl.org")
ensembl <- useDataset("bterrestris_eg_gene", mart = ensembl)
transcript_to_gene <- getBM(attributes = c("ensembl_transcript_id", "ensembl_gene_id"), 
                            mart = ensembl)

# Use tximport on kallisto files 
## Counts are estimated counts from kallisto:
txi_counts <- tximport(paths$kallisto_files, 
                       type    = "kallisto", 
                       tx2gene = transcript_to_gene,
                       countsFromAbundance = "no")

# Save object for use in other scripts
dir.create(path="results/count_estimates/")
save(txi_counts, file = "results/count_estimates/txi_count_estimates.Rdata")
```

### Step Four: Run DESeq2 for differential expression analysis:

For identifying differentially expressed genes, a DESeq object is generated containing:
    a. sample names
    b. treatments
    
Within the present analysis, two questions can be immediately asked:
    1. What genes are differentially expressed within clothianidin-exposed workers in comparison to control?
    2. What genes are differentially expressed within imidacloprid-exposed workers in comparison to control?

```{r}
## Construct DESeq data set from txi object and sample information:
deseq_txi <- DESeqDataSetFromTximport(txi     = txi_counts, 
                                      colData = samples, 
                                      design  = ~batch + room + treatment)
```

# Run DESeq2 (Wald test) for differential expression analysis:
  Which genes are differentially expressed between each treatment and control?
  Running a Wald t-test (default test within DESeq2)
```{r}
##==================================================================================================================
## 4.1) Which genes are differentially expressed within clothianidin-exposed workers in comparison to control?
##==================================================================================================================
## Perform a pairwise comparison between treatments:
deseq_object  <- DESeq(deseq_txi, 
                       test = "Wald", 
                       betaPrior = TRUE)

## Save object for use in generating heatmap(s)
dir.create(path = "results/deseq_wald_object_output/")
save(deseq_object, file = "results/deseq_wald_object_output/deseq_wald_object.Rdata")

## Extract results for clothianidin vs. control:
deseq_results_CLO_vs_CON <- results(deseq_object, contrast = c("treatment", "CLO", "CON"))                                           

## Convert into a dataframe:
deseq_results_CLO_vs_CON_df <- as.data.frame(deseq_results_CLO_vs_CON)

# Results table ordered by smallest p value
deseq_results_CLO_vs_CON_df_ordered <- deseq_results_CLO_vs_CON_df[order(deseq_results_CLO_vs_CON_df$pvalue),]

## Create directory for output:
dir.create(path = "results/deseq2_clo_raw_output/")

## Save to file:
write.table(x = deseq_results_CLO_vs_CON_df_ordered, 
            file ="results/deseq2_clo_raw_output/deseq_results_CLO_vs_CON_raw_corrected_for_batch_room.txt", 
            sep = "\t",
            quote = FALSE)

## Subset significant genes:
deseq_results_CLO_vs_CON_df_ordered_sig <- subset(deseq_results_CLO_vs_CON_df_ordered, padj < 0.05)

## Create directory for output:
dir.create(path = "./results/deseq2_clo_sig_output/")

## Save to file:
write.table(x = deseq_results_CLO_vs_CON_df_ordered_sig, 
            file ="results/deseq2_clo_sig_output/deseq_results_CLO_vs_CON_significant_corrected_for_batch_room.txt", 
            sep = "\t",
            quote = FALSE)

# Save significant genes for heatmap input 
de_genes_CLO <- rownames(deseq_results_CLO_vs_CON_df_ordered_sig)

## Save object for use in generating heatmap(s)
save(de_genes_CLO, file = "results/deseq2_clo_sig_output/deseq_object_clo_sig_genes.Rdata")

##-----------------------------------------------------------------------------------------------------------------
## 4.1.1) How many and which genes are more/less expressed in clothianidin-exposed workers in comparison to control?
##-----------------------------------------------------------------------------------------------------------------
# Identify genes more highly expressed in CLO group 
deseq_results_CLO_vs_CON_df_ordered_sig_high <- subset(deseq_results_CLO_vs_CON_df_ordered_sig, log2FoldChange > 0)
nrow(deseq_results_CLO_vs_CON_df_ordered_sig_high)

# Identify genes less expressed in CLO group 
deseq_results_CLO_vs_CON_df_ordered_sig_low <- subset(deseq_results_CLO_vs_CON_df_ordered_sig, log2FoldChange < 0)
nrow(deseq_results_CLO_vs_CON_df_ordered_sig_low)
```

```{r}
##==================================================================================================================
## 4.2 Which genes are differentially expressed within imidacloprid-exposed workers in comparison to control?
##==================================================================================================================
## Extract results for imidacloprid vs. control
deseq_results_IMI_vs_CON <- results(deseq_object, contrast = c("treatment", "CON", "IMI")) 

## Convert into a dataframe:
deseq_results_IMI_vs_CON_df <- as.data.frame(deseq_results_IMI_vs_CON)

# Results table ordered by smallest p value
deseq_results_IMI_vs_CON_df_ordered <- deseq_results_IMI_vs_CON_df[order(deseq_results_IMI_vs_CON_df$pvalue),]

## Create directory for output:
dir.create(path = "results/deseq2_imi_raw_output/")

## Save to file:
write.table(x = deseq_results_IMI_vs_CON_df_ordered, 
            file ="results/deseq2_imi_raw_output/deseq_results_IMI_vs_CON_raw_corrected_for_batch_room.txt", 
            sep = "\t",
            quote = FALSE)

## Subset significant genes:
deseq_results_IMI_vs_CON_df_ordered_sig <- subset(deseq_results_IMI_vs_CON_df_ordered, padj < 0.05)

## Create directory for output:
dir.create(path = "./results/deseq2_imi_sig_output/")

## Save to file:
write.table(x = deseq_results_IMI_vs_CON_df_ordered_sig, 
            file ="results/deseq2_imi_sig_output/deseq_results_IMI_vs_CON_significant_corrected_for_batch_room.txt", 
            sep = "\t",
            quote = FALSE)

# Save significant genes for heatmap input 
de_genes_IMI <- rownames(deseq_results_IMI_vs_CON_df_ordered_sig)

## Save object for use in generating heatmap(s)
save(de_genes_IMI, file = "results/deseq2_imi_sig_output/deseq_object_sig_genes.Rdata")

##-----------------------------------------------------------------------------------------------------------------
## 4.2.1) How many and which genes are more/less expressed in imidacloprid-exposed workers in comparison to control?
##-----------------------------------------------------------------------------------------------------------------
# Identify genes more highly expressed in CLO group 
deseq_results_IMI_vs_CON_df_ordered_sig_high <- subset(deseq_results_IMI_vs_CON_df_ordered_sig, log2FoldChange > 0)
nrow(deseq_results_IMI_vs_CON_df_ordered_sig_high)

# Identify genes less expressed in CLO group 
deseq_results_IMI_vs_CON_df_ordered_sig_low <- subset(deseq_results_IMI_vs_CON_df_ordered_sig, log2FoldChange < 0)
nrow(deseq_results_IMI_vs_CON_df_ordered_sig_low)    
```

```{r}
##=========================================================================================
## 4.3 Generate a report on fold changes between treatments
##=========================================================================================
## Generate a report of differentially expressed genes and output in folder 'reports'.
## Report results in the generation of boxplots for each statistically significant gene:
deseq_report <- HTMLReport(shortName = 'RNAseq_analysis_with_DESeq2',
                           title     = 'RNA-seq analysis of differential expressed transcripts using DESeq2',
                           reportDirectory = "results/")

## Publish report:
publish(deseq_object, deseq_report, pvalueCutoff = 0.05,
        factor = colData(deseq_object)$treatment,
        reportDir = "results/")

## Complete the report:        
finish(deseq_report)
```

### Step Five: Extract results for output for use in GO term analyses.
For this we need extract the Wald test result adjusted p values.

```{r}
# Extract list of genes from the DESeq objects
# i) For clothianidin
de_genes_for_topGO_CLO <- data.frame(locus      = row.names(deseq_results_CLO_vs_CON_df), 
                                     raw_pvalue = deseq_results_CLO_vs_CON_df$pvalue)

# ii) For imidacloprid
de_genes_for_topGO_IMI <- data.frame(locus      = row.names(deseq_results_IMI_vs_CON_df), 
                                     raw_pvalue = deseq_results_IMI_vs_CON_df$pvalue)
# Order by p-values 
de_genes_for_topGO_CLO <- de_genes_for_topGO_CLO[order(de_genes_for_topGO_CLO$raw_pvalue),]
de_genes_for_topGO_IMI <- de_genes_for_topGO_IMI[order(de_genes_for_topGO_IMI$raw_pvalue),]

## Create directory for output:
dir.create(path = "./results/input_for_go_term_analysis/wald_clo", recursive = TRUE)
dir.create(path = "./results/input_for_go_term_analysis/wald_imi", recursive = TRUE)

## Write to output:
write.table(de_genes_for_topGO_CLO, 
            file = "results/input_for_go_term_analysis/wald_clo/de_genes_for_topGO.txt", 
            row.names = FALSE, 
            sep = "\t",
            quote = FALSE)

write.table(de_genes_for_topGO_IMI, 
            file = "results/input_for_go_term_analysis/wald_imi/de_genes_for_topGO.txt", 
            row.names = FALSE, 
            sep = "\t",
            quote = FALSE)
```

### Step Six: Principal Components Analysis
```{r}
## Extracting transformed values from DESeq object:
vsd <- vst(deseq_object, blind = FALSE)
rld <- rlog(deseq_object, blind = FALSE)

# this gives log2(n + 1)
ntd        <- normTransform(deseq_object)

## Basic plot:
plotPCA(vsd, intgroup = c("treatment"))

## Extract first and second principal components:
pca_data    <- plotPCA(vsd, intgroup = c("treatment"), returnData = TRUE)

## Extract percentages for first two principal components:
percentVar <- round(100 * attr(pca_data, "percentVar"))

## Plot PCA:
ggplot(pca_data, aes(PC1, PC2, color = treatment, shape = treatment)) +
       geom_point(size = 5, shape = 16) +
       xlab(paste0("PC1: ",percentVar[1],"% variance")) +
       ylab(paste0("PC2: ",percentVar[2],"% variance")) + 
       coord_fixed() +
       scale_color_manual(values = c("blue", "grey", "black")) +
       theme_bw() +
       theme(axis.title = element_text(family = "Arial", color = "#666666", face = "bold", size = 16)) 
    
```



