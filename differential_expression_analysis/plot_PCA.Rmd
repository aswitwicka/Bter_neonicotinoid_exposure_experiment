--- 
title: "Bombus pesticide exposure: gene expression in head"
output: principal_component_analyis.html
--- 

# Introduction
This script is for plotting principal components generated for a PCA performed on log transformed estimated counts for genes generated by tximport and DESeq2.

This script will import estimated genes counts from tximport and use the R package [DESeq2](http://bioconductor.org/packages/release/bioc/html/DESeq.html) to perform a principal component analysis. 
This script produces a scatterplot for first two principal components, plotted using [ggplot2](https://cran.r-project.org/web/packages/ggplot2/index.html). The plot points are labelled with information, including:
1) Sample name 
2) Room name (name of room where bees were maintained during experiment)
3) Batch block (two blocks were used for experiments)
This can then be used for further analysis. 

Step One: load  libraries:

```{r}
# Load libraries; install from scratch if needed
libraries <- c("tximport", "readr", "DESeq2", "ggplot2", "gplots", "rhdf5",
               "plyr", "ggfortify", "ReportingTools", "vsn", "RColorBrewer")
for (lib in libraries) {
    if (require(package = lib, character.only = TRUE)) {
        print("Successful")
    } else {
        print("Installing")
        source("https://bioconductor.org/biocLite.R")
        biocLite(pkgs = lib)
        library(lib, character.only = TRUE )
    }
}
dir.create("results")
```

Step Two: perform and plot PCA

```{r}
## Load in DESeq object:
source("results/differential_expression/deseq_object.Rdata")

## Extract and transform values from DESeq object using variance stabilizing transformations (VST) as recommended in the DESeq2 manual
vsd <- vst(deseq_txi, blind = FALSE)

## Basic plot:
plotPCA(vsd, intgroup = c("treatment"))

## Extract first and second principal components:
pca_data    <- plotPCA(vsd, intgroup = c("treatment"), returnData = TRUE)

## Extract percentages for first two principal components:
percentVar <- round(100 * attr(pca_data, "percentVar"))

## Add information on batch and room:
room_block_information <- read.table("input/differential_expression/room_and_block_information_per_sample.txt", header = FALSE)

## Add information to the dataframe containing PCs:
pca_data$room <- room_block_information$V7
pca_data$block <- room_block_information$V8

## Plot PCA:
ggplot(pca_data, aes(PC1, PC2, color = treatment, shape = treatment)) +
       geom_point(size = 2, shape = 16) +
       geom_text(aes(label=name), hjust=0.5, vjust=1) +
       geom_text(aes(label=room), hjust=0.5, vjust=2) +
       geom_text(aes(label=block), hjust=0.5, vjust=3) + 
       xlab(paste0("PC1: ",percentVar[1],"% variance")) +
       ylab(paste0("PC2: ",percentVar[2],"% variance")) + 
       coord_fixed() +
       scale_color_manual(values = c("blue", "black", "red")) +
       theme_bw() +
       theme(axis.title = element_text(family = "Arial", color = "#666666", face = "bold", size = 16)) 

```
