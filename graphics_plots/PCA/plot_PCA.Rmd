--- 
title: "Bombus pesticide exposure: gene expression in head"
output: principal_component_analyis.html
--- 

# Introduction
This script is for plotting principal components generated for a PCA performed on log transformed estimated counts for genes generated by tximport and DESeq2.

This script will import estimated genes counts from tximport and use the R package [DESeq2](http://bioconductor.org/packages/release/bioc/html/DESeq.html) to perform a principal component analysis. 
This script produces a scatterplot for first two principal components, plotted using [ggplot2](https://cran.r-project.org/web/packages/ggplot2/index.html). The plot points are labelled with information, including:
1) Sample name 
2) Room name (name of room where bees were maintained during experiment)
3) Batch block (two blocks were used for experiments)
This can then be used for further analysis. 

Step One: load  libraries:

```{r}
# Load libraries; install from scratch if needed
libraries <- c("tximport", "readr", "DESeq2", "ggplot2", "gplots", "rhdf5",
               "plyr", "ggfortify", "ReportingTools", "vsn", "RColorBrewer", "ggpubr", "metaMA")
for (lib in libraries) {
    if (require(package = lib, character.only = TRUE)) {
        print("Successful")
    } else {
        print("Installing")
        source("https://bioconductor.org/biocLite.R")
        biocLite(pkgs = lib)
        library(lib, character.only = TRUE )
    }
}
dir.create("results")
```

Step Two: perform and plot PCA

```{r}
## Load in DESeq object:
load("input/differential_expression/deseq_object_workers.Rdata")
load("input/differential_expression/deseq_object_queens.Rdata")

## Extract and transform values from DESeq object using variance stabilizing transformations (VST) as recommended in the DESeq2 manual
vsd_workers <- vst(deseq_object_workers, blind = FALSE)
vsd_queens <- vst(deseq_object_queens, blind = FALSE)

## Add information on batch and room:
room_block_information <- read.table("input/differential_expression/room_and_block_information_per_sample.txt", header = FALSE)

## Perform PCA:
pca_data_workers <- plotPCA(vsd_workers, intgroup = c("treatment"), returnData = TRUE)

## Extract percentages for first two principal components:
percentVar_workers <- round(100 * attr(pca_data_workers, "percentVar"))

## Add information to the dataframe containing PCs:
pca_data_workers$room <- room_block_information$V2
pca_data_workers$block <- room_block_information$V3

## Plot PCA:
ggplot(pca_data_workers, aes(PC1, PC2, color = treatment, shape = treatment)) +
       geom_point(size = 2, shape = 16) +
       #geom_text(aes(label=name), hjust=0.5, vjust=1) +
       geom_text(aes(label=room), hjust=0.5, vjust=-1) +
       geom_text(aes(label=block), hjust=0.5, vjust=1.5) + 
       xlab(paste0("PC1: ",percentVar_workers[1],"% variance")) +
       ylab(paste0("PC2: ",percentVar_workers[2],"% variance")) + 
       coord_fixed() +
       scale_color_manual(values = c("blue", "black", "orange")) +
       theme_bw() +
       theme(axis.title = element_text(family = "Arial", color = "#666666", face = "bold", size = 16)) 

```


```{r}
plotPCA <- function (object, intgroup = "condition", ntop = 500, returnData = FALSE) 
{
    rv <- rowVars(assay(object))
    select <- order(rv, decreasing = TRUE)[seq_len(min(ntop, 
        length(rv)))]
    pca <- prcomp(t(assay(object)[select, ]))
    percentVar <- pca$sdev^2/sum(pca$sdev^2)
    if (!all(intgroup %in% names(colData(object)))) {
        stop("the argument 'intgroup' should specify columns of colData(dds)")
    }
    intgroup.df <- as.data.frame(colData(object)[, intgroup, 
        drop = FALSE])
    group <- if (length(intgroup) > 1) {
        factor(apply(intgroup.df, 1, paste, collapse = " : "))
    }
    else {
        colData(object)[[intgroup]]
    }
    d <- data.frame(PC1 = pca$x[, 1], PC2 = pca$x[, 2], PC3 = pca$x[, 3], PC4 = pca$x[, 4], group = group, 
        intgroup.df, name = colnames(object))
    if (returnData) {
        attr(d, "percentVar") <- percentVar[1:4]
        return(d)
    }
    ggplot(data = d, aes_string(x = "PC3", y = "PC4", color = "group")) + 
        geom_point(size = 3) + xlab(paste0("PC3: ", round(percentVar[3] * 
        100), "% variance")) + ylab(paste0("PC4: ", round(percentVar[4] * 
        100), "% variance")) + coord_fixed()
}

## Rework PCA function for extraction for first four components:
pca_data_workers <- plotPCA(vsd_workers, intgroup=c("treatment"), returnData = T)

## extract percentages:
percentVar_workers <- round(100 * attr(pca_data_workers, "percentVar"))

## Add information for 
pca_data_workers$room <- room_block_information$V2
pca_data_workers$block <- room_block_information$V3

## Plot first two principal components:
plot_1_2 <- ggplot(pca_data_workers, aes(PC1, PC2, color = treatment, shape = treatment)) +
       geom_point(size = 2, shape = 16) +
       #geom_text(aes(label=name), hjust=0.5, vjust=1) +
       geom_text(aes(label=room), hjust=0.5, vjust=-1) +
       geom_text(aes(label=block), hjust=0.5, vjust=1.5) + 
       xlab(paste0("PC1: ",percentVar_workers[1],"% variance")) +
       ylab(paste0("PC2: ",percentVar_workers[2],"% variance")) + 
       coord_fixed() +
       scale_color_manual(values = c("blue", "black", "orange")) +
       theme_bw() +
       theme(axis.title = element_text(family = "Arial", color = "#666666", face = "bold", size = 16)) 

plot_2_3 <- ggplot(pca_data_workers, aes(PC2, PC3, color = treatment, shape = treatment)) +
       geom_point(size = 2, shape = 16) +
       #geom_text(aes(label=name), hjust=0.5, vjust=1) +
       geom_text(aes(label=room), hjust=0.5, vjust=-1) +
       geom_text(aes(label=block), hjust=0.5, vjust=1.5) + 
       xlab(paste0("PC2: ",percentVar_workers[2],"% variance")) +
       ylab(paste0("PC3: ",percentVar_workers[3],"% variance")) + 
       coord_fixed() +
       scale_color_manual(values = c("blue", "black", "orange")) +
       theme_bw() +
       theme(axis.title = element_text(family = "Arial", color = "#666666", face = "bold", size = 16)) 

plot_3_4 <- ggplot(pca_data_workers, aes(PC3, PC4, color = treatment, shape = treatment)) +
       geom_point(size = 2, shape = 16) +
       #geom_text(aes(label=name), hjust=0.5, vjust=1) +
       geom_text(aes(label=room), hjust=0.5, vjust=-1) +
       geom_text(aes(label=block), hjust=0.5, vjust=1.5) + 
       xlab(paste0("PC3: ",percentVar_workers[3],"% variance")) +
       ylab(paste0("PC4: ",percentVar_workers[4],"% variance")) + 
       coord_fixed() +
       scale_color_manual(values = c("blue", "black", "orange")) +
       theme_bw() +
       theme(axis.title = element_text(family = "Arial", color = "#666666", face = "bold", size = 16)) 

## Plot together:
ggarrange(plot_1_2, plot_2_3, plot_3_4,
          nrow =2, ncol =2,
          labels=c("PC1 vs PC2", "PC2 vs PC3", "PC3 vs PC4"),
          align = "h")
```

Plot for the queen data:

```{r}
## Rework PCA function for extraction for first four components:
pca_data_queens <- plotPCA(vsd_queens, intgroup=c("treatment"), returnData = T)

## extract percentages:
percentVar_queens <- round(100 * attr(pca_data_queens, "percentVar"))

## Add information for 
pca_data_queens$room <- room_block_information$V2
pca_data_queens$block <- room_block_information$V3

## Plot first two principal components:
plot_queen_1_2 <- ggplot(pca_data_queens, aes(PC1, PC2, color = treatment, shape = treatment)) +
       geom_point(size = 2, shape = 16) +
       #geom_text(aes(label=name), hjust=0.5, vjust=1) +
       geom_text(aes(label=room), hjust=0.5, vjust=-1) +
       geom_text(aes(label=block), hjust=0.5, vjust=1.5) + 
       xlab(paste0("PC1: ",percentVar_queens[1],"% variance")) +
       ylab(paste0("PC2: ",percentVar_queens[2],"% variance")) + 
       coord_fixed() +
       scale_color_manual(values = c("blue", "black", "orange")) +
       theme_bw() +
       theme(axis.title = element_text(family = "Arial", color = "#666666", face = "bold", size = 16)) 

plot_queen_2_3 <- ggplot(pca_data_queens, aes(PC2, PC3, color = treatment, shape = treatment)) +
       geom_point(size = 2, shape = 16) +
       #geom_text(aes(label=name), hjust=0.5, vjust=1) +
       geom_text(aes(label=room), hjust=0.5, vjust=-1) +
       geom_text(aes(label=block), hjust=0.5, vjust=1.5) + 
       xlab(paste0("PC2: ",percentVar_queens[2],"% variance")) +
       ylab(paste0("PC3: ",percentVar_queens[3],"% variance")) + 
       coord_fixed() +
       scale_color_manual(values = c("blue", "black", "orange")) +
       theme_bw() +
       theme(axis.title = element_text(family = "Arial", color = "#666666", face = "bold", size = 16)) 

plot_queen_3_4 <- ggplot(pca_data_queens, aes(PC3, PC4, color = treatment, shape = treatment)) +
       geom_point(size = 2, shape = 16) +
       #geom_text(aes(label=name), hjust=0.5, vjust=1) +
       geom_text(aes(label=room), hjust=0.5, vjust=-1) +
       geom_text(aes(label=block), hjust=0.5, vjust=1.5) + 
       xlab(paste0("PC3: ",percentVar_queens[3],"% variance")) +
       ylab(paste0("PC4: ",percentVar_queens[4],"% variance")) + 
       coord_fixed() +
       scale_color_manual(values = c("blue", "black", "orange")) +
       theme_bw() +
       theme(axis.title = element_text(family = "Arial", color = "#666666", face = "bold", size = 16)) 

## Plot together:
ggarrange(plot_queen_1_2, plot_queen_2_3, plot_queen_3_4,
          nrow =2, ncol =2,
          labels=c("PC1 vs PC2", "PC2 vs PC3", "PC3 vs PC4"),
          align = "h")
```
