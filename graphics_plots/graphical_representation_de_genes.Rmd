--- 
title: "Graphical representation of DE genes"
output: 2018-02-28-graphics.nb.html
--- 
---

## Introduction:
#=================
##This script is for exploratory analysis of transcript quantification data and results of differential gene expression analysis.
##Input files should be R objects saved and generated from previous scripts of DE analysis, including the object resulting from using tximport() on kallisto files, the significant transcript abundances selected from this object and a results table of significant genes, generated using DESeq2. 
##This script will organise input data for generating heatmaps of significantly differentially expressed genes, based on statistical significance and log fold changes in expression.
##This script produces heatmaps that can be exported. 

```{r}
# Load libraries; install from scratch if needed
libraries <- c("ggplot2", "gplots", "heatmap3", "ggfortify", "ggDESeq", "reshape")
for (lib in libraries) {
    if (require(package = lib, character.only = TRUE)) {
        print("Successful")
    } else {
        print("Installing")
        source("https://bioconductor.org/biocLite.R")
        biocLite(pkgs = lib)
        library(lib, character.only = TRUE )
    }
}

# Load R objects from previous script output
load("input/graphical_representation/txi_counts.Rdata")
load("input/graphical_representation/deseq_object.Rdata")
load("input/graphical_representation/de_genes_CLO.RData")
load("input/graphical_representation/de_genes_IMI.RData")

dir.create("results/graphical_representation")

```


## Step One: Heatmaps for visualisation of significantly differentially expressed transcripts
```{r}
## Generate results table for DE genes between treatments:
# Set colour pattern
scalepurpleyellow <- colorRampPalette(colors = c("black", "white", "red"))(700)

## The function takes a z-normalised dataframe as input
plot_heatmap              <- function(input){
                             heatmap.2(input, 
                             col = scalepurpleyellow, 
                             trace = "none",
                             margins = c(8,23), 
                             sepwidth = c(0.01, 0.01), 
                             sepcolor = "black", 
                             colsep = c(0,4,8,12),
                             cexRow = 1,
                             Colv = NULL,
                             Rowv = TRUE,
                             labRow = rownames(input))
}

##==================================================================================================================
## 1.1 Genes significantly differentially expressed in clothianidin and imidacloprid group
##==================================================================================================================
## Select relevant gene counts from DESeq results (de_genes)
# normalise counts 
normalised_counts_df <- t(scale(t(txi_counts$counts), center = TRUE, scale = TRUE))

# Select significant gene counts
significant_de_counts <- normalised_counts_df[de_genes_CLO,]

# Add sample numbers to columns 
colnames(significant_de_counts) <- gsub(x = colnames(significant_de_counts), pattern = "-C.*", replacement = "")
colnames(significant_de_counts) <- paste(colnames(significant_de_counts),+rep(1:4,2))

### Replace LOC gene names with descriptions
# Import txt file with gene descriptions
genes_for_heatmap <- read.table("input/graphical_representation/de_genes_description.txt", header = FALSE,
                                sep = "\t")

# Check order matches with rownames of heatmap object 
if (any(genes_for_heatmap$V1 != rownames(significant_de_counts))) {
    stop("genes not matched!") 
}

genes_for_heatmap <- as.character(genes_for_heatmap$V2)

# Replace rownames with gene descriptions
rownames(significant_de_counts) <- genes_for_heatmap

# Cut rownames
rownames(significant_de_counts)  <- gsub(x = rownames(significant_de_counts), pattern = "[,[].+", replacement = "")

# Export plot 
tiff("results/graphical_representation/de_genes_heatmap.tiff", width = 10, height = 7, units = 'in', res = 200)
plot_heatmap(significant_de_counts)
dev.off()

##### Still to work out putting sig IMI gene last!
```

Alternative code for plotting heatmap:

```{r}
## Convert significant counts into a dataframe:
significant_de_counts_df <- as.data.frame(significant_de_counts)

## Add column with gene information:
significant_de_counts_df$gene_name <- rownames(significant_de_counts_df)

## Reshape using 'melt':
significant_de_counts_df_melt <- melt(significant_de_counts_df)

## Rename column names:
colnames(significant_de_counts_df_melt) <- c("gene_name", "sample", "logFC")

## Plot heatmap:
ggplot(significant_de_counts_df_melt, aes(sample, gene_name)) +
                  geom_tile(aes(fill = logFC), color = "black") +
                  geom_vline(xintercept = c(4.5, 8.5)) +
                  scale_fill_gradient2(low = "grey", mid="white", high = "red") +
                  ylab("Gene names") +
                  xlab("Sample names") +
                  theme(legend.title = element_text(size = 15, face="bold"),
                  legend.text = element_text(size = 15, face="bold"),
                  axis.text.x = element_text(angle = 45, hjust = 1, size=8, face="bold"),
                  axis.text.y= element_text(size=8, face="bold"),
                  axis.title=element_text(size=14,face="bold")) +
                  theme(legend.position="top") +
                  scale_y_discrete(position = "right")

```
