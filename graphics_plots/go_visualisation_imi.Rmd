---
title: "R Notebook"
output: html_notebook
---
title: "Bombus pesticide exposure: gene expression in head"
output: GO_enrichment_visualisation.html
---

## Introduction 
# This script is for visualisation of the output of gene ontology (GO) analyses using the R package TopGo.
# This script creates a barchart of the number of significant genes annotated to a particular GO term, with an associated p-value.
# This script takes an input of .csv files containing an output table of GO analyses.

```{r}
# Load libraries; install from scratch if needed
libraries <- c("ggplot2", "lattice", "ggpubr")
for (lib in libraries) {
    if (require(package = lib, character.only = TRUE)) {
        print("Successful")
    } else {
        print("Installing")
        source("https://bioconductor.org/biocLite.R")
        biocLite(pkgs = lib)
        library(lib, character.only = TRUE )
    }
}
```

## Step One: Load input files
```{r}
### imidacloprid GO analyses
imidacloprid_worker_deseq_BP <- read.table(file="input/worker/input_imi/BP_sig.txt", 
                                           header = TRUE)

imidacloprid_worker_deseq_MF <- read.table(file="input/worker/input_imi/MF_sig.txt", 
                                           header = TRUE)

imidacloprid_worker_deseq_CC <- read.table(file="input/worker/input_imi/CC_sig.txt", 
                                           header = TRUE)

## Combined:
imidacloprid_worker_deseq_combined <- rbind(imidacloprid_worker_deseq_BP, 
                                            imidacloprid_worker_deseq_MF,
                                            imidacloprid_worker_deseq_CC)

imidacloprid_worker_deseq_combined$category <- factor(imidacloprid_worker_deseq_combined$category)

## Read in data for queens:
imidacloprid_queen_deseq_BP <- read.table(file="input/queen/input_imi/BP_sig.txt", 
                                           header = TRUE)

imidacloprid_queen_deseq_MF <- read.table(file="input/queen/input_imi/MF_sig.txt", 
                                           header = TRUE)

imidacloprid_queen_deseq_CC <- read.table(file="input/queen/input_imi/CC_sig.txt", 
                                           header = TRUE)

## Combined:
imidacloprid_queen_deseq_combined <- rbind(imidacloprid_queen_deseq_BP, 
                                            imidacloprid_queen_deseq_MF,
                                            imidacloprid_queen_deseq_CC)

# Set order of GO categories to plot
levels(imidacloprid_worker_deseq_combined$category) <- c("BP", "MF", "CC")
levels(imidacloprid_queen_deseq_combined$category) <- c("BP", "MF", "CC")

# Round p values to plot
imidacloprid_worker_deseq_combined$weight_ks <- round(imidacloprid_worker_deseq_combined$weight_ks, digits = 3)
imidacloprid_queen_deseq_combined$weight_ks <- round(imidacloprid_queen_deseq_combined$weight_ks, digits = 3)

# Log p values for plotting 
imidacloprid_worker_deseq_combined$weight_ks <- -log(imidacloprid_worker_deseq_combined$weight_ks)
imidacloprid_queen_deseq_combined$weight_ks <- -log(imidacloprid_queen_deseq_combined$weight_ks)
```

## Step Two: Plot a barchart of GO terms and number of genes, for both worker and queen GO analyses, with significance values (ks tests)
```{r}
# Reorder terms for plotting 
imidacloprid_worker_deseq_combined$Term <- factor(imidacloprid_worker_deseq_combined$Term, levels = imidacloprid_worker_deseq_combined$Term[order(imidacloprid_worker_deseq_combined$category, imidacloprid_worker_deseq_combined$weight_ks)])

imidacloprid_queen_deseq_combined$Term <- factor(imidacloprid_queen_deseq_combined$Term, levels = imidacloprid_queen_deseq_combined$Term[order(imidacloprid_queen_deseq_combined$category, imidacloprid_queen_deseq_combined$weight_ks)])

## For plotting queen, update GO term names to include total number of annotated terms:
imidacloprid_worker_deseq_combined$updated_terms <- paste(imidacloprid_worker_deseq_combined$Term, " ", "(", imidacloprid_worker_deseq_combined$Annotated, ")", sep="")

imidacloprid_queen_deseq_combined$updated_terms <- paste(imidacloprid_queen_deseq_combined$Term, " ", "(", imidacloprid_queen_deseq_combined$Annotated, ")", sep="")

## Remove underscores:
imidacloprid_worker_deseq_combined$updated_terms <- gsub("_", " ", imidacloprid_worker_deseq_combined$updated_terms)
imidacloprid_queen_deseq_combined$updated_terms <- gsub("_", " ", imidacloprid_queen_deseq_combined$updated_terms)

# Plot for workers:
imidacloprid_worker_deseq_plot<- ggbarplot(imidacloprid_worker_deseq_combined, x = "updated_terms", y = "weight_ks",
                      position = position_dodge(0.1),
                      fill = "category",# change fill color by mpg_level
                      color = NULL, #"white"            # Set bar border colors to white
                      palette = "jco",# jco journal color palett. see ?ggpar
                      sort.val = "asc",          # Sort the value in descending order
                      sort.by.groups = TRUE,     # Don't sort inside each group
                      ylab = "-log10(p)",
                      xlab = "Gene ontology term",
                      legend.title = "Gene ontology",
                      lab.col = "black",
                      lab.size = 4,
                      lab.vjust = 0.5,
                      lab.hjust = 1,
                      legend = "top",
                      rotate = TRUE,
                      ggtheme = theme_minimal())

imidacloprid_worker_deseq_plot <- imidacloprid_worker_deseq_plot +
                                scale_y_continuous(expand = c(0, 0)) +
                                theme(axis.text=element_text(size=15),
                                      axis.title.x = element_text(size=15,face="bold"),
                                      axis.title.y = element_text(size=15,face="bold"),
                                      axis.text.y = element_text(size=12, face="bold"),
                                      axis.text.x = element_text(size=12),
                                      legend.position="none") +
                                expand_limits(y = 10) +
                                geom_hline(yintercept = 1.301, linetype="dashed", colour="black")

## Update colours for plotting
imidacloprid_worker_deseq_plot<- imidacloprid_worker_deseq_plot + 
                                scale_fill_manual(values = c("orange", 
                                                             "light blue", 
                                                             "light grey"))

## Plot queen:
imidacloprid_queen_deseq_plot <- ggbarplot(imidacloprid_queen_deseq_combined, x = "updated_terms", y = "weight_ks",
                      position = position_dodge(0.1),
                      fill = "category",# change fill color by mpg_level
                      color = NULL, #"white"            # Set bar border colors to white
                      palette = "jco",# jco journal color palett. see ?ggpar
                      sort.val = "asc",          # Sort the value in descending order
                      sort.by.groups = TRUE,     # Don't sort inside each group
                      ylab = "-log10(p)",
                      xlab = "Gene ontology term",
                      legend.title = "Gene ontology",
                      lab.col = "black",
                      lab.size = 4,
                      lab.vjust = 0.5,
                      lab.hjust = 1,
                      legend = "top",
                      rotate = TRUE,
                      ggtheme = theme_minimal())

imidacloprid_queen_deseq_plot <- imidacloprid_queen_deseq_plot +
                                scale_y_continuous(expand = c(0, 0)) +
                                theme(axis.text=element_text(size=15),
                                      axis.title.x = element_text(size=15,face="bold"),
                                      axis.title.y = element_text(size=15,face="bold"),
                                      axis.text.y = element_text(size=12, face="bold"),
                                      axis.text.x = element_text(size=12),
                                      legend.position="none") +
                                expand_limits(y = 10) +
                                geom_hline(yintercept = 1.301, linetype="dashed", colour="black")

## Update colours for plotting
imidacloprid_queen_deseq_plot <- imidacloprid_queen_deseq_plot + 
                                 scale_fill_manual(values = c("orange", 
                                                             "light blue", 
                                                             "light grey"))

```

Plot together:

```{r}
## Plot:
ggarrange(imidacloprid_worker_deseq_plot, 
          imidacloprid_queen_deseq_plot,
          nrow=2, ncol=1,
          labels=c("A", "B"),
          align="hv",
          heights = c(1.5,1.5),
                    font.label = list(size = 10))

## Save picture:
ggsave("imidacloprid_queen_deseq_combined.pdf", height = 20, width = 18)
```
