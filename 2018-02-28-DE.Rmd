--- 
title: "Differential gene expression analyses"
output: 2018-02-28-DE.nb.html
--- 
---
### Introduction 
#This script is for differential gene expression analysis of transcript quantification data.
#Input files should be abundance files (.h5, .tsv, .json) generated by Kallisto (https://pachterlab.github.io/kallisto/manual) for each sample and .txt file of genome transcripts and their corresponding gene ids (LOC numbers)
#This script will import abundance files from Kallisto and use the R package 'DESeq2' (http://bioconductor.org/packages/release/bioc/html/DESeq.html) on count data to test for differential expression based on a model using negative binomial distribution.
#This script produces a results table of genes that are significantly differentially expressed, following DESeq2 analysis. The results of which can then be used for further analysis. 
---

```{r}
########## load packages 
library(tximport)
library(readr)
library(DESeq2)
library(ggplot2)
library(ggfortify)
library(ReportingTools)
source("https://bioconductor.org/biocLite.R")
biocLite("vsn")
library("vsn")
library("RColorBrewer")

### set wd 
setwd("/Users/isabelfletcher/Documents/LIDo/R1/RNAseq/2018-02-28-Differential_Expression")

```
##Step One:
## Input results from kallisto
```{r} 
## Set paths to folders containing output files from kallisto
paths <- list()
paths$data <- "." 
paths$kallisto_output <- file.path(paths$data, "2018-02-13-kallisto_quantification")

paths$kallisto_files_relative <- grep(x = list.files(paths$kallisto_output, recursive = TRUE),
                                      pattern = ".tsv", value = TRUE)
paths$kallisto_files <- file.path(paths$kallisto_output,
                                  paths$kallisto_files_relative)


# Save path to use later
kallisto_quant_file_path <- "2018-01-11-kallisto_quantification"

# Automatically extract file names from kallisto output for colnames
names_tmp <- gsub(x = paths$kallisto_files, pattern = "./2018-01-11-kallisto_quantification/2016-Bter-", replacement = "")
names_tmp <- gsub(x = names_tmp, pattern = "-head.+", replacement = "")
names <- gsub(x = names_tmp, pattern = ".*Bter-", replacement = "")
rm(names_tmp)

```
##Step Two: Put sample names and treatments into a samples dataframe for DESeqDataSetFromTximport
```{r}
## Extract sample names and put into df for tximport
samples_tmp <- gsub(x = paths$kallisto_files, pattern = ".*Bter-", replacement = "")
samples  <- data.frame(treatment = samples)
rownames(samples) <- gsub(x = samples_tmp,     pattern = "-head.*",     replacement = "")
rm(samples_tmp)

```
##Step Three: Tximport
```{r}
### Calculate differential expression between genes ###
# Import
library(readr)

# Read in file corresponding to transcripts to gene ids
tx2gene <- read.table("./rna_and_corresponding_gene_ids.txt", header = F)
head(tx2gene)

# Assign column names
# Column 1: transcript name
# Column 2: gene name
colnames(tx2gene) <- c("TXNAME","GENEID")

# Use tximport on kallisto files 
## Counts are output for TPM values scaled to gene length:
txi <- tximport(paths$kallisto_files, type = "kallisto", 
                tx2gene = tx2gene,
                countsFromAbundance = c("lengthScaledTPM"))

## Convert to dataframe for potential plots:
colnames(txi$counts) <- names #label columns with treatments
txi_counts_df <- as.data.frame(txi$counts)
save(txi_counts_df, file = "txi_counts_df.Rdata")

# Save object for use in other scripts
save(txi, file = "txi.Rdata")

```
##Step Four:
## Run DESeq2 for differential expression analysis 
```{r}
############## DESeq
# Construct DESeq data set from txi object and sample information
deseq_txi <- DESeqDataSetFromTximport(txi, colData = samples, design = ~ treatment) 

## Relevel treatments, so CON is defined as base
deseq_txi$treatment <- relevel(deseq_txi$treatment, "CON")

# Perform differential expression analysis
design(deseq_txi) <- ~ treatment
deseq_object <- DESeq(deseq_txi)

## Running a likelihood ratio test
# Make sure that all files for each condition of interest are read into the DESEq object:
deseq_object_LRT <- DESeq(deseq_txi, test = "LRT", reduced = ~1)

# Save object for later use
save(deseq_object_LRT, file = "deseq_object_LRT.Rdata")

```

### Generate results tables for differentially expressed genes
```{r}
## Save results names from DESeq object 
deseq_results_names <- resultsNames(deseq_object_LRT)

# Generate results table for DE genes, specifying contrasts
deseq_results_CON_CLO <- results(deseq_object_LRT, contrast = c("treatment", "CON","CLO"))

deseq_results_CON_IMI <- results(deseq_object_LRT, contrast = c("treatment", "CON","IMI"))

## Log fold change shrinkage for ranking and visualisation, provide lfcshrink() with the DESeq object 
deseq_results_shrink_CON_CLO <- lfcShrink(deseq_object_LRT, contrast = c("treatment", "CON","CLO"))
deseq_results_shrink_CON_IMI <- lfcShrink(deseq_object_LRT, contrast = c("treatment", "CON","IMI"))

# Order results by p value
deseq_results_ordered_CON_CLO <- deseq_results_shrink_CON_CLO[order(deseq_results_shrink_CON_CLO$padj),]
deseq_results_ordered_CON_IMI <- deseq_results_shrink_CON_CLO[order(deseq_results_shrink_CON_IMI$padj),]

```

# Create table of significant genes
```{r}
## Create table of significant genes 
deseq_results_significant <- deseq_results_ordered_CON_CLO[which(deseq_results_ordered_CON_CLO$padj < 0.05), ]

# Save table for further use
save(deseq_results_significant, file = "deseq_results_significant.Rdata")

# Put significant DE gene names into an object
de_genes <- rownames(deseq_results_significant)

de_genes <- gsub(x = de_genes, pattern = ".+rna_", replacement = "")
de_genes <- gsub(x = de_genes, pattern = "[:.:][0-9].+", replacement = "")

# Export object into .txt file, for GO analysis
write(de_genes, "de_genes.txt")
```

## Results of log fold changes in expression between pairwise comparisons of treatments
# 1) CON and CLO
```{r}
# Order DE genes by lfc
de_logchange_CON_CLO <- deseq_results_significant[order(deseq_results_significant$log2FoldChange),]

# Genes more highly expressed in CLO treatment, compared to CON i.e. negative lfc values
de_logchange_CON_CLO_high <- deseq_results_significant[deseq_results_significant$log2FoldChange < 0,]

# Genes less expressed in CLO treatment, compared to CON
de_logchange_CON_CLO_low <- deseq_results_significant[deseq_results_significant$log2FoldChange > 0,]

```
# 2) CON and IMI
```{r}
# Create table of significant results for CON vs. IMI first
deseq_results_significant_CON_IMI <- deseq_results_ordered_CON_IMI[which(deseq_results_ordered_CON_IMI$padj < 0.05), ]

# Order DE genes by lfc 
de_logchange_CON_IMI <- deseq_results_significant_CON_IMI[order(deseq_results_significant_CON_IMI$log2FoldChange),]

# Genes more highly expressed in IMI treatment, compared to CON i.e. negative lfc values
de_logchange_CON_IMI_high <- deseq_results_significant_CON_IMI[deseq_results_significant_CON_IMI$log2FoldChange < 0,]

# Genes less expressed in IMI treatment, compared to CON i.e. positive lfc values
de_logchange_CON_IMI_low <- deseq_results_significant_CON_IMI[deseq_results_significant_CON_IMI$log2FoldChange > 0,]

```

##Step Six: Principal Components Analysis
```{r}
## Extracting transformed values from DESeq object:
vsd <- vst(deseq_object_LRT, blind = FALSE)
rld <- rlog(deseq_object_LRT, blind = FALSE)

# this gives log2(n + 1)
ntd        <- normTransform(deseq_object_LRT)

## Basic plot:
plotPCA(vsd, intgroup = c("treatment"))

## Extract first and second principal components:
pca_data    <- plotPCA(vsd, intgroup = c("treatment"), returnData = TRUE)

## Extract percentages for first two principal components:
percentVar <- round(100 * attr(pca_data, "percentVar"))

## Plot PCA:
ggplot(pca_data, aes(PC1, PC2, color = treatment, shape = treatment)) +
       geom_point(size = 5, shape = 16) +
       xlab(paste0("PC1: ",percentVar[1],"% variance")) +
       ylab(paste0("PC2: ",percentVar[2],"% variance")) + 
       coord_fixed() +
       scale_color_manual(values = c("blue", "grey", "black")) +
       theme_bw() +
       theme(axis.title = element_text(family = "Arial", color = "#666666", face = "bold", size = 16)) 

        
```


#Step Six
## Making report with boxplots, for exploratory analysis 
```{r}
deseq_report <- HTMLReport(shortName = 'RNAseq_analysis_with_DESeq2',
                         title = 'RNA-seq analysis of differential expression using DESeq2',
                         reportDirectory = "./reports")

publish(deseq_object_LRT,deseq_report, pvalueCutoff = 0.05,
        factor = colData(deseq_object_LRT)$treatment,
        reportDir = "./reports")
        
finish(deseq_report)
```





